name: Handle Closed Submission

on:
  issues:
    types: [closed]

jobs:
  award-badge:
    runs-on: ubuntu-latest
    
    # Only run if issue has 'submission' label AND closed by nisalgunawardhana
    if: |
      contains(github.event.issue.labels.*.name, 'submission') &&
      github.event.sender.login == 'nisalgunawardhana'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Add completion labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const currentLabels = context.payload.issue.labels.map(label => label.name);
            const labelsToAdd = [];
            
            if (!currentLabels.includes('reviewed')) {
              labelsToAdd.push('reviewed');
            }
            if (!currentLabels.includes('completed')) {
              labelsToAdd.push('completed');
            }
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labelsToAdd
              });
            }
      
      - name: Read and encode badge
        id: badge
        run: |
          if [ -f "Images/badge.png" ]; then
            base64_badge=$(base64 -i Images/badge.png)
            echo "badge_exists=true" >> $GITHUB_OUTPUT
            echo "Badge file found"
          else
            echo "badge_exists=false" >> $GITHUB_OUTPUT
            echo "Badge file not found"
          fi
      
      - name: Add congratulations comment with badge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueUrl = context.payload.issue.html_url;
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const badgeUrl = `${repoUrl}/raw/main/Images/badge.png`;
            
            const comment = `ğŸŠ **Congratulations, @${context.payload.issue.user.login}!**
            
            This issue has been closed, which means you have **successfully completed this task!** ğŸ‰
            
            ## ğŸ† Your Digital Badge
            
            ![Digital Badge](${badgeUrl})
            
            ## ğŸ“¢ Share Your Achievement
            
            You can showcase your knowledge and share this accomplishment on:
            - ğŸ’¼ **LinkedIn** - Add this to your profile or share as a post
            - ğŸ¦ **Twitter/X** - Tweet about your achievement
            - ğŸ“± **Other Social Media** - Instagram, Facebook, etc.
            
            **Reference Link:** ${issueUrl}
            
            Feel free to mention that you've completed this assessment and link to this issue as proof of your work!
            
            ---
            
            Keep up the excellent work! ğŸš€âœ¨`;

            const commentResponse = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            console.log(`Comment created: ${commentResponse.data.html_url}`);
